<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.2.xsd
http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.2.xsd">
	
	<import resource="../momime.common.spring/momime-common-beans.xml"/>
	
	<!-- General XSD objects (may move these into common project at some stage)-->
	
	<bean id="domImplementationRegistry" class="org.w3c.dom.bootstrap.DOMImplementationRegistry" factory-method="newInstance" />
	
	<bean id="commonXsdResourceResolver" class="momime.common.database.CommonXsdResourceResolver">
		<constructor-arg ref="domImplementationRegistry" />
	</bean>
	
	<bean id="schemaFactory" class="javax.xml.validation.SchemaFactory" factory-method="newInstance">
		<constructor-arg value="http://www.w3.org/2001/XMLSchema" />
		<property name="resourceResolver" ref="commonXsdResourceResolver" />
	</bean>	
	
	<!-- Server config XML -->
	
	<bean id="serverConfigSchema" class="javax.xml.validation.Schema" factory-bean="schemaFactory" factory-method="newSchema">
		<constructor-arg value="/momime.server.config/MoMIMEServerConfig.xsd"/>
	</bean>
	
	<bean id="serverConfigJaxbContext" class="javax.xml.bind.JAXBContext" factory-method="newInstance">
		<constructor-arg>
    		<list>
    			<value>momime.server.config.v0_9_4.MomImeServerConfig</value>
    		</list>
   		</constructor-arg>
	</bean>
	
	<bean id="serverConfigUnmarshaller" class="javax.xml.bind.Unmarshaller" factory-bean="serverConfigJaxbContext" factory-method="createUnmarshaller">
		<property name="schema" ref="serverConfigSchema" />
	</bean>
	
	<bean id="serverConfig" class="momime.server.config.v0_9_4.MomImeServerConfig" factory-bean="serverConfigUnmarshaller" factory-method="unmarshal">
		<constructor-arg value="MoMIMEServerConfig.xml" />
	</bean>
	
	<!-- Server database XMLs -->

	<bean id="serverDatabaseSchema" class="javax.xml.validation.Schema" factory-bean="schemaFactory" factory-method="newSchema">
		<constructor-arg value="/momime.server.database/MoMIMEServerDatabase.xsd"/>
	</bean>
	
	<bean id="serverDatabaseJaxbContext" class="javax.xml.bind.JAXBContext" factory-method="newInstance">
		<constructor-arg>
    		<list>
    			<value>momime.server.database.v0_9_4.ServerDatabase</value>
    		</list>
   		</constructor-arg>
	</bean>
	
	<bean id="serverDatabaseFactory" class="momime.server.database.ServerDatabaseFactory" />	<!-- Creates ServerDatabaseExImpl instead of ServerDatabase -->
	
	<bean id="serverDatabaseUnmarshaller" class="javax.xml.bind.Unmarshaller" factory-bean="serverDatabaseJaxbContext" factory-method="createUnmarshaller">
		<property name="schema" ref="serverDatabaseSchema" />
	</bean>
	
	<bean id="configureServerDatabaseUnmarshaller" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
		<property name="targetObject" ref="serverDatabaseUnmarshaller" />
		<property name="targetMethod" value="setProperty" />
		<property name="arguments">
			<list>
				<value>com.sun.xml.bind.ObjectFactory</value>
				<array>
					<ref bean="serverDatabaseFactory" />
				</array>
			</list>
		</property>
	</bean>	
	
	<!-- Create extended versions of client to server messages which include message implementations -->

	<bean id="momServerClientToServerFactory" class="org.springframework.beans.factory.config.ServiceLocatorFactoryBean" >
		<property name="serviceLocatorInterface" value="momime.server.messages.process.ClientToServerMessagesFactory" />
	</bean>			

	<bean id="momServerClientToServerObjectFactory" class="momime.server.messages.process.ClientToServerMessagesObjectFactory">
		<property name="factory" ref="momServerClientToServerFactory" />
	</bean>
	
	<bean id="chooseWizardMessage" class="momime.server.messages.process.ChooseWizardMessageImpl" scope="prototype">
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
	</bean>
	
	<bean id="chooseInitialSpellsMessage" class="momime.server.messages.process.ChooseInitialSpellsMessageImpl" scope="prototype">
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
	</bean>
	
	<bean id="chooseCustomFlagColourMessage" class="momime.server.messages.process.ChooseCustomFlagColourMessageImpl" scope="prototype" />
	
	<bean id="chooseCustomPicksMessage" class="momime.server.messages.process.ChooseCustomPicksMessageImpl" scope="prototype">
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
	</bean>
	
	<bean id="chooseRaceMessage" class="momime.server.messages.process.ChooseRaceMessageImpl" scope="prototype">
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
	</bean>
	
	<bean id="uploadCustomPhotoMessage" class="momime.server.messages.process.UploadCustomPhotoMessageImpl" scope="prototype" />
	<bean id="chooseStandardPhotoMessage" class="momime.server.messages.process.ChooseStandardPhotoMessageImpl" scope="prototype" />
	
	<bean id="nextTurnButtonMessage" class="momime.server.messages.process.NextTurnButtonMessageImpl" scope="prototype">
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
	</bean>
	
	<bean id="chatMessage" class="momime.server.messages.process.ChatMessageImpl" scope="prototype">
		<property name="multiplayerServerUtils" ref="multiplayerServerUtils" />
	</bean>
	
	<bean id="changeCityConstructionMessage" class="momime.server.messages.process.ChangeCityConstructionMessageImpl" scope="prototype">
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="sellBuildingMessage" class="momime.server.messages.process.SellBuildingMessageImpl" scope="prototype">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="cityProcessing" ref="cityProcessing" />
	</bean>
	
	<bean id="rushBuyMessage" class="momime.server.messages.process.RushBuyMessageImpl" scope="prototype">
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
	</bean>
	
	<bean id="changeTaxRateMessage" class="momime.server.messages.process.ChangeTaxRateMessageImpl" scope="prototype">
		<property name="cityProcessing" ref="cityProcessing" />
	</bean>
	
	<bean id="changeOptionalFarmersMessage" class="momime.server.messages.process.ChangeOptionalFarmersMessageImpl" scope="prototype">
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="chooseCityNameMessage" class="momime.server.messages.process.ChooseCityNameMessageImpl" scope="prototype">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="requestOverlandMovementDistancesMessage" class="momime.server.messages.process.RequestOverlandMovementDistancesMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
	</bean>
	
	<bean id="requestMoveOverlandUnitStackMessage" class="momime.server.messages.process.RequestMoveOverlandUnitStackMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="alchemyMessage" class="momime.server.messages.process.AlchemyMessageImpl" scope="prototype">
		<property name="playerPickUtils" ref="playerPickUtils" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
	</bean>
	
	<bean id="updateMagicPowerDistributionMessage" class="momime.server.messages.process.UpdateMagicPowerDistributionMessageImpl" scope="prototype" />
	
	<bean id="specialOrderButtonMessage" class="momime.server.messages.process.SpecialOrderButtonMessageImpl" scope="prototype">
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
	</bean>
	
	<bean id="captureCityDecisionMessage" class="momime.server.messages.process.CaptureCityDecisionMessageImpl" scope="prototype">
		<property name="combatStartAndEnd" ref="combatStartAndEnd" />
	</bean>
	
	<bean id="dismissUnitMessage" class="momime.server.messages.process.DismissUnitMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="requestUpdateUnitNameMessage" class="momime.server.messages.process.RequestUpdateUnitNameMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="cancelPendingMovementAndSpecialOrdersMessage" class="momime.server.messages.process.CancelPendingMovementAndSpecialOrdersMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="pendingMovementUtils" ref="pendingMovementUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
	</bean>
	
	<bean id="requestResearchSpellMessage" class="momime.server.messages.process.RequestResearchSpellMessageImpl" scope="prototype">
		<property name="spellUtils" ref="spellUtils" />
		<property name="spellServerUtils" ref="spellServerUtils" />
	</bean>
	
	<bean id="requestCastSpellMessage" class="momime.server.messages.process.RequestCastSpellMessageImpl" scope="prototype">
		<property name="spellQueueing" ref="spellQueueing" />
	</bean>
	
	<bean id="targetSpellMessage" class="momime.server.messages.process.TargetSpellMessageImpl" scope="prototype">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="spellUtils" ref="spellUtils" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>
	
	<bean id="cancelTargetSpellMessage" class="momime.server.messages.process.CancelTargetSpellMessageImpl" scope="prototype">
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
	</bean>

	<bean id="requestSwitchOffMaintainedSpellMessage" class="momime.server.messages.process.RequestSwitchOffMaintainedSpellMessageImpl" scope="prototype">
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="spellProcessing" ref="spellProcessing" />
	</bean>
	
	<bean id="attackNodeLairTowerMessage" class="momime.server.messages.process.AttackNodeLairTowerMessageImpl" scope="prototype">
		<property name="combatStartAndEnd" ref="combatStartAndEnd" />
	</bean>

	<bean id="endCombatTurnMessage" class="momime.server.messages.process.EndCombatTurnMessageImpl" scope="prototype">
		<property name="combatProcessing" ref="combatProcessing" />
	</bean>
	
	<bean id="combatAutoControlMessage" class="momime.server.messages.process.CombatAutoControlMessageImpl" scope="prototype">
		<property name="combatProcessing" ref="combatProcessing" />
	</bean>
	
	<bean id="requestMoveCombatUnitMessage" class="momime.server.messages.process.RequestMoveCombatUnitMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="combatProcessing" ref="combatProcessing" />
	</bean>
	
	<bean id="requestStartScheduledCombatMessage" class="momime.server.messages.process.RequestStartScheduledCombatMessageImpl" scope="prototype">
		<property name="scheduledCombatUtils" ref="scheduledCombatUtils" />
		<property name="multiplayerServerUtils" ref="multiplayerServerUtils" />
		<property name="combatProcessing" ref="combatProcessing" />
	</bean>

	<bean id="unrequestStartScheduledCombatMessage" class="momime.server.messages.process.UnrequestStartScheduledCombatMessageImpl" scope="prototype" />
	
	<bean id="choseNotToDoScheduledCombatMessage" class="momime.server.messages.process.ChoseNotToDoScheduledCombatMessageImpl" scope="prototype">
		<property name="combatScheduler" ref="combatScheduler" />
	</bean>
	
	<!-- Version of the server -->
	
	<context:property-placeholder location="classpath:MoMIMEServerVersion.properties" />
	
	<!-- Singleton beans for server -->
	
	<bean id="multiplayerSessionServerClientToServerObjectFactory" class="com.ndg.multiplayer.server.messages.process.MultiplayerSessionServerClientToServerObjectFactory" />
	
	<bean id="multiplayerServerUtils" class="com.ndg.multiplayer.server.MultiplayerServerUtilsImpl" />
	
	<bean id="userRegistry" class="com.ndg.multiplayer.server.users.MultiplayerSessionUserRegistryImpl">
		<constructor-arg value="#{serverConfig.userRegistryFilename}" />
		<constructor-arg value="#{serverConfig.createUserRegistry}" />
	</bean>

	<bean id="serverDatabaseConverters" class="momime.server.database.ServerDatabaseConvertersImpl" />
	
	<bean id="newGameDatabaseMessage" class="momime.common.messages.servertoclient.v0_9_5.NewGameDatabaseMessage" factory-bean="serverDatabaseConverters" factory-method="buildNewGameDatabase">
		<constructor-arg value="#{serverConfig.pathToServerXmlDatabases}" />
		<constructor-arg ref="serverDatabaseUnmarshaller" />
	</bean>
	
	<bean id="momServer" class="momime.server.MomServer" init-method="start">
		<property name="clientToServerContext" ref="clientToServerJaxbContext" />
		<property name="serverToClientContext" ref="serverToClientJaxbContext" />
		<property name="clientToServerContextFactoryArray">
			<array>
				<ref bean="multiplayerSessionServerClientToServerObjectFactory" />
				<ref bean="momServerClientToServerObjectFactory" />
				<ref bean="objectFactoryMap" />
			</array>
		</property>
		<property name="serverDatabaseConverters" ref="serverDatabaseConverters" />
		<property name="serverDatabaseUnmarshaller" ref="serverDatabaseUnmarshaller" />
		<property name="userRegistry" ref="userRegistry" />
		<property name="newGameDatabaseMessage" ref="newGameDatabaseMessage" />
		<property name="port" value="#{serverConfig.portNumber}" />
		<property name="pathToServerXmlDatabases" value="#{serverConfig.pathToServerXmlDatabases}" />
		<property name="version" value="${momime.server.version}" />
		<property name="uiClassName" value="#{serverConfig.uiClassName}" />
		<property name="sessionThreadFactory" ref="sessionThreadFactory" />
	</bean>
	
	<bean id="booleanMapAreaOperations2D" class="com.ndg.map.areas.operations.BooleanMapAreaOperations2DImpl">
		<property name="randomUtils" ref="randomUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>

	<!-- Utils -->

	<bean id="playerPickServerUtils" class="momime.server.utils.PlayerPickServerUtilsImpl">
		<property name="playerPickUtils" ref="playerPickUtils" />
		<property name="spellUtils" ref="spellUtils" />
		<property name="spellAI" ref="spellAI" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="overlandMapServerUtils" class="momime.server.utils.OverlandMapServerUtilsImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>

	<bean id="unitServerUtils" class="momime.server.utils.UnitServerUtilsImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="pendingMovementUtils" ref="pendingMovementUtils" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>

	<bean id="cityServerUtils" class="momime.server.utils.CityServerUtilsImpl">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
	</bean>

	<bean id="spellServerUtils" class="momime.server.utils.SpellServerUtilsImpl">
		<property name="spellUtils" ref="spellUtils" />
	</bean>

	<bean id="playerServerUtils" class="momime.server.utils.PlayerServerUtilsImpl" />
	
	<!-- Calculations -->
	
	<bean id="serverSpellCalculations" class="momime.server.calculations.MomServerSpellCalculationsImpl">
		<property name="spellUtils" ref="spellUtils" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="serverCityCalculations" class="momime.server.calculations.MomServerCityCalculationsImpl">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
	</bean>

	<bean id="serverUnitCalculations" class="momime.server.calculations.MomServerUnitCalculationsImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>

	<bean id="serverResourceCalculations" class="momime.server.calculations.MomServerResourceCalculationsImpl">
		<property name="spellQueueing" ref="spellQueueing" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="spellUtils" ref="spellUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="playerPickUtils" ref="playerPickUtils" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="serverSpellCalculations" ref="serverSpellCalculations" />
		<property name="momResourceConsumerFactory" ref="momResourceConsumerFactory" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="damageCalculator" class="momime.server.calculations.DamageCalculatorImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>
	
	<bean id="combatMapGenerator" class="momime.server.mapgenerator.CombatMapGeneratorImpl">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="combatMapUtils" ref="combatMapUtils" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>
	
	<!-- Resource consumers -->

	<bean id="momResourceConsumerFactory" class="org.springframework.beans.factory.config.ServiceLocatorFactoryBean" >
		<property name="serviceLocatorInterface" value="momime.server.process.resourceconsumer.MomResourceConsumerFactory" />
	</bean>			

	<bean id="momResourceConsumerBuilding" class="momime.server.process.resourceconsumer.MomResourceConsumerBuilding" scope="prototype">
		<property name="cityProcessing" ref="cityProcessing" />
	</bean>

	<bean id="momResourceConsumerUnit" class="momime.server.process.resourceconsumer.MomResourceConsumerUnit" scope="prototype">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="momResourceConsumerSpell" class="momime.server.process.resourceconsumer.MomResourceConsumerSpell" scope="prototype">
		<property name="spellProcessing" ref="spellProcessing" />
	</bean>

	<!-- Processing -->

	<bean id="playerMessageProcessing" class="momime.server.process.PlayerMessageProcessingImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="skillCalculations" ref="skillCalculations" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="cityProcessing" ref="cityProcessing" />
		<property name="spellQueueing" ref="spellQueueing" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
		<property name="serverSpellCalculations" ref="serverSpellCalculations" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="momAI" ref="momAI" />
		<property name="cityAI" ref="cityAI" />
		<property name="multiplayerServerUtils" ref="multiplayerServerUtils" />
		<property name="playerServerUtils" ref="playerServerUtils" />
		<property name="simultaneousTurnsProcessing" ref="simultaneousTurnsProcessing" />
		<property name="combatScheduler" ref="combatScheduler" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="cityProcessing" class="momime.server.process.CityProcessingImpl">
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="cityAI" ref="cityAI" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="spellProcessing" class="momime.server.process.SpellProcessingImpl">
		<property name="spellUtils" ref="spellUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
		<property name="combatProcessing" ref="combatProcessing" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="combatMapUtils" ref="combatMapUtils" />
		<property name="spellCalculations" ref="spellCalculations" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="spellQueueing" class="momime.server.process.SpellQueueingImpl">
	</bean>

	<bean id="damageProcessor" class="momime.server.process.DamageProcessorImpl">
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="damageCalculator" ref="damageCalculator" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="combatStartAndEnd" ref="combatStartAndEnd" />
	</bean>

	<bean id="combatStartAndEnd" class="momime.server.process.CombatStartAndEndImpl">
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="scheduledCombatUtils" ref="scheduledCombatUtils" />
		<property name="combatScheduler" ref="combatScheduler" />
		<property name="combatMapGenerator" ref="combatMapGenerator" />
		<property name="combatProcessing" ref="combatProcessing" />
	</bean>

	<bean id="combatProcessing" class="momime.server.process.CombatProcessingImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarDuplication" ref="fogOfWarDuplication" />
		<property name="combatScheduler" ref="combatScheduler" />
		<property name="combatMapUtils" ref="combatMapUtils" />
		<property name="combatAI" ref="combatAI" />
		<property name="damageProcessor" ref="damageProcessor" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="combatStartAndEnd" ref="combatStartAndEnd" />
	</bean>
	
	<bean id="combatScheduler" class="momime.server.process.CombatSchedulerImpl">
		<property name="multiplayerServerUtils" ref="multiplayerServerUtils" />
		<property name="scheduledCombatUtils" ref="scheduledCombatUtils" />
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
	</bean>

	<bean id="simultaneousTurnsProcessing" class="momime.server.process.SimultaneousTurnsProcessingImpl">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="cityProcessing" ref="cityProcessing" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<!-- AI -->
	
	<bean id="spellAI" class="momime.server.ai.SpellAIImpl">
		<property name="spellUtils" ref="spellUtils" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="cityAI" class="momime.server.ai.CityAIImpl">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>

	<bean id="momAI" class="momime.server.ai.MomAIImpl">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="spellAI" ref="spellAI" />
		<property name="cityAI" ref="cityAI" />
	</bean>

	<bean id="combatAI" class="momime.server.ai.CombatAIImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="combatProcessing" ref="combatProcessing" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>
	
	<!-- Fog of War -->

	<bean id="fogOfWarCalculations" class="momime.server.calculations.MomFogOfWarCalculationsImpl">
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
	</bean>

	<bean id="fogOfWarDuplication" class="momime.server.fogofwar.FogOfWarDuplicationImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
	</bean>

	<bean id="fogOfWarMidTurnChanges" class="momime.server.fogofwar.FogOfWarMidTurnChangesImpl">
		<property name="fogOfWarCalculations" ref="fogOfWarCalculations" />
		<property name="fogOfWarDuplication" ref="fogOfWarDuplication" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
		<property name="pendingMovementUtils" ref="pendingMovementUtils" />
		<property name="combatProcessing" ref="combatProcessing" />
		<property name="combatScheduler" ref="combatScheduler" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>

	<bean id="fogOfWarProcessing" class="momime.server.fogofwar.FogOfWarProcessingImpl">
		<property name="fogOfWarDuplication" ref="fogOfWarDuplication" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>
	
	<!-- Beans created each time a new session is started
	
			Note have to be careful here that each bean is only referenced once - if, for example, we declare
			"trueMap" as a prototype bean and then try to set it against both the gsk + map generator, they
			will both get different copies of "trueMap" injected
			
			So if there are places that something is genuinely required twice, we have to declare it only
			once here and then deal with copying the reference within the code -->
			
	<bean id="sessionThreadFactory" class="org.springframework.beans.factory.config.ServiceLocatorFactoryBean" >
		<property name="serviceLocatorInterface" value="momime.server.MomSessionThreadFactory" />
	</bean>			

	<bean id="trueMap" class="momime.common.messages.v0_9_5.FogOfWarMemory" scope="prototype" />

	<bean id="gsk" class="momime.server.messages.v0_9_5.MomGeneralServerKnowledge" scope="prototype">
		<property name="trueMap" ref="trueMap" />
		<property name="nextFreeUnitURN" value="1" />
		<property name="nextFreeScheduledCombatURN" value="1" />
	</bean>

	<bean id="gpk" class="momime.common.messages.v0_9_5.MomGeneralPublicKnowledge" scope="prototype" />
	
	<bean id="overlandMapGenerator" class="momime.server.mapgenerator.OverlandMapGeneratorImpl" scope="prototype">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="booleanMapAreaOperations2D" ref="booleanMapAreaOperations2D" />
		<!-- <property name="trueTerrain" ref="trueMap" /> see comment above, this is done in the code instead -->
	</bean>

	<bean id="sessionThread" class="momime.server.MomSessionThread" scope="prototype">
		<property name="generalPublicKnowledge" ref="gpk" />
		<property name="generalServerKnowledge" ref="gsk" />
		<property name="utils" ref="multiplayerServerUtils" />
		<property name="overlandMapGenerator" ref="overlandMapGenerator" />
	</bean>
	
</beans>