<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd">
	
	<import resource="../com.ndg.multiplayer.server/session-server-beans.xml" />
	<import resource="../momime.common.spring/momime-common-beans.xml" />

	<!-- Version of the server - process this first so it displays on the UI as soon as possible -->
	
	<context:property-placeholder location="classpath:MoMIMEServerVersion.properties" />
	
	<bean id="versionSetter" class="momime.server.ui.MomServerUIVersionSetter">
		<property name="version" value="${momime.server.version}" />
	</bean>
	
	<!-- General XSD objects (may move these into common project at some stage) -->
	
	<bean id="domImplementationRegistry" class="org.w3c.dom.bootstrap.DOMImplementationRegistry" factory-method="newInstance" />
	
	<bean id="commonXsdResourceResolver" class="momime.common.database.CommonXsdResourceResolver">
		<constructor-arg ref="domImplementationRegistry" />
	</bean>
	
	<bean id="schemaFactory" class="javax.xml.validation.SchemaFactory" factory-method="newInstance">
		<constructor-arg value="http://www.w3.org/2001/XMLSchema" />
		<property name="resourceResolver" ref="commonXsdResourceResolver" />
	</bean>
	
	<!-- Server config XML -->
	
	<bean id="serverConfigSchema" class="javax.xml.validation.Schema" factory-bean="schemaFactory" factory-method="newSchema">
		<constructor-arg type="java.net.URL" value="/momime.server.config/MoMIMEServerConfig.xsd" />
	</bean>
	
	<bean id="serverConfigJaxbContext" class="javax.xml.bind.JAXBContext" factory-method="newInstance">
		<constructor-arg>
    		<list>
    			<value>momime.server.config.v0_9_7.MomImeServerConfig</value>
    		</list>
   		</constructor-arg>
	</bean>
	
	<bean id="serverConfigUnmarshaller" class="javax.xml.bind.Unmarshaller" factory-bean="serverConfigJaxbContext" factory-method="createUnmarshaller">
		<property name="schema" ref="serverConfigSchema" />
	</bean>
	
	<bean id="serverConfig" class="momime.server.config.v0_9_7.MomImeServerConfig" factory-bean="serverConfigUnmarshaller" factory-method="unmarshal">
		<constructor-arg value="${configDir}MoMIMEServerConfig.xml" />
	</bean>
	
	<!-- Server database XMLs -->

	<bean id="serverDatabaseSchema" class="javax.xml.validation.Schema" factory-bean="schemaFactory" factory-method="newSchema">
		<constructor-arg type="java.net.URL" value="/momime.server.database/MoMIMEServerDatabase.xsd" />
	</bean>
	
	<bean id="serverDatabaseJaxbContext" class="javax.xml.bind.JAXBContext" factory-method="newInstance">
		<constructor-arg>
    		<list>
    			<value>momime.server.database.v0_9_7.ServerDatabase</value>
    		</list>
   		</constructor-arg>
	</bean>

	<bean id="serverDatabaseFactory" class="org.springframework.beans.factory.config.ServiceLocatorFactoryBean" >
		<property name="serviceLocatorInterface" value="momime.server.database.ServerDatabaseFactory" />
	</bean>			
	
	<bean id="serverDatabaseObjectFactory" class="momime.server.database.ServerDatabaseObjectFactory">	<!-- Creates ServerDatabaseExImpl instead of ServerDatabase -->
		<property name="factory" ref="serverDatabaseFactory" />
	</bean>	
	
	<bean id="serverDatabaseUnmarshaller" class="javax.xml.bind.Unmarshaller" factory-bean="serverDatabaseJaxbContext" factory-method="createUnmarshaller">
		<property name="schema" ref="serverDatabaseSchema" />
	</bean>
	
	<bean id="configureServerDatabaseUnmarshaller" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
		<property name="targetObject" ref="serverDatabaseUnmarshaller" />
		<property name="targetMethod" value="setProperty" />
		<property name="arguments">
			<list>
				<value>com.sun.xml.bind.ObjectFactory</value>
				<array>
					<ref bean="serverDatabaseObjectFactory" />
				</array>
			</list>
		</property>
	</bean>
	
	<bean id="serverDatabase" class="momime.server.database.ServerDatabaseExImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
	</bean>
	
	<!-- Create extended versions of client to server messages which include message implementations -->

	<bean id="momServerClientToServerFactory" class="org.springframework.beans.factory.config.ServiceLocatorFactoryBean" >
		<property name="serviceLocatorInterface" value="momime.server.messages.process.ClientToServerMessagesFactory" />
	</bean>			

	<bean id="momServerClientToServerObjectFactory" class="momime.server.messages.process.ClientToServerMessagesObjectFactory">
		<property name="factory" ref="momServerClientToServerFactory" />
	</bean>
	
	<bean id="chooseWizardMessage" class="momime.server.messages.process.ChooseWizardMessageImpl" scope="prototype">
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
	</bean>
	
	<bean id="chooseInitialSpellsMessage" class="momime.server.messages.process.ChooseInitialSpellsMessageImpl" scope="prototype">
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
	</bean>
	
	<bean id="chooseCustomFlagColourMessage" class="momime.server.messages.process.ChooseCustomFlagColourMessageImpl" scope="prototype" />
	
	<bean id="chooseCustomPicksMessage" class="momime.server.messages.process.ChooseCustomPicksMessageImpl" scope="prototype">
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
	</bean>
	
	<bean id="chooseRaceMessage" class="momime.server.messages.process.ChooseRaceMessageImpl" scope="prototype">
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
	</bean>
	
	<bean id="uploadCustomPhotoMessage" class="momime.server.messages.process.UploadCustomPhotoMessageImpl" scope="prototype" />
	<bean id="chooseStandardPhotoMessage" class="momime.server.messages.process.ChooseStandardPhotoMessageImpl" scope="prototype" />
	
	<bean id="nextTurnButtonMessage" class="momime.server.messages.process.NextTurnButtonMessageImpl" scope="prototype">
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
	</bean>
	
	<bean id="chatMessage" class="momime.server.messages.process.ChatMessageImpl" scope="prototype">
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
	</bean>
	
	<bean id="changeCityConstructionMessage" class="momime.server.messages.process.ChangeCityConstructionMessageImpl" scope="prototype">
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
	</bean>
	
	<bean id="sellBuildingMessage" class="momime.server.messages.process.SellBuildingMessageImpl" scope="prototype">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="cityProcessing" ref="cityProcessing" />
	</bean>
	
	<bean id="rushBuyMessage" class="momime.server.messages.process.RushBuyMessageImpl" scope="prototype">
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="changeTaxRateMessage" class="momime.server.messages.process.ChangeTaxRateMessageImpl" scope="prototype">
		<property name="cityProcessing" ref="cityProcessing" />
	</bean>
	
	<bean id="changeOptionalFarmersMessage" class="momime.server.messages.process.ChangeOptionalFarmersMessageImpl" scope="prototype">
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="chooseCityNameMessage" class="momime.server.messages.process.ChooseCityNameMessageImpl" scope="prototype">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="requestOverlandMovementDistancesMessage" class="momime.server.messages.process.RequestOverlandMovementDistancesMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
	</bean>
	
	<bean id="requestMoveOverlandUnitStackMessage" class="momime.server.messages.process.RequestMoveOverlandUnitStackMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="fogOfWarMidTurnMultiChanges" ref="fogOfWarMidTurnMultiChanges" />
	</bean>
	
	<bean id="alchemyMessage" class="momime.server.messages.process.AlchemyMessageImpl" scope="prototype">
		<property name="playerPickUtils" ref="playerPickUtils" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
	</bean>
	
	<bean id="updateMagicPowerDistributionMessage" class="momime.server.messages.process.UpdateMagicPowerDistributionMessageImpl" scope="prototype" />
	
	<bean id="specialOrderButtonMessage" class="momime.server.messages.process.SpecialOrderButtonMessageImpl" scope="prototype">
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
	</bean>
	
	<bean id="captureCityDecisionMessage" class="momime.server.messages.process.CaptureCityDecisionMessageImpl" scope="prototype">
		<property name="combatStartAndEnd" ref="combatStartAndEnd" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
	</bean>
	
	<bean id="dismissUnitMessage" class="momime.server.messages.process.DismissUnitMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="requestUpdateUnitNameMessage" class="momime.server.messages.process.RequestUpdateUnitNameMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="cancelPendingMovementAndSpecialOrdersMessage" class="momime.server.messages.process.CancelPendingMovementAndSpecialOrdersMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="pendingMovementUtils" ref="pendingMovementUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
	</bean>
	
	<bean id="requestResearchSpellMessage" class="momime.server.messages.process.RequestResearchSpellMessageImpl" scope="prototype">
		<property name="spellUtils" ref="spellUtils" />
		<property name="spellServerUtils" ref="spellServerUtils" />
	</bean>
	
	<bean id="requestCastSpellMessage" class="momime.server.messages.process.RequestCastSpellMessageImpl" scope="prototype">
		<property name="spellQueueing" ref="spellQueueing" />
	</bean>
	
	<bean id="targetSpellMessage" class="momime.server.messages.process.TargetSpellMessageImpl" scope="prototype">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="spellUtils" ref="spellUtils" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarMidTurnMultiChanges" ref="fogOfWarMidTurnMultiChanges" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>
	
	<bean id="cancelTargetSpellMessage" class="momime.server.messages.process.CancelTargetSpellMessageImpl" scope="prototype">
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
	</bean>

	<bean id="requestSwitchOffMaintainedSpellMessage" class="momime.server.messages.process.RequestSwitchOffMaintainedSpellMessageImpl" scope="prototype">
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="spellProcessing" ref="spellProcessing" />
	</bean>
	
	<bean id="endCombatTurnMessage" class="momime.server.messages.process.EndCombatTurnMessageImpl" scope="prototype">
		<property name="combatProcessing" ref="combatProcessing" />
	</bean>
	
	<bean id="combatAutoControlMessage" class="momime.server.messages.process.CombatAutoControlMessageImpl" scope="prototype">
		<property name="combatProcessing" ref="combatProcessing" />
	</bean>
	
	<bean id="requestMoveCombatUnitMessage" class="momime.server.messages.process.RequestMoveCombatUnitMessageImpl" scope="prototype">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="combatProcessing" ref="combatProcessing" />
	</bean>

	<bean id="requestMoveHeroItemMessage" class="momime.server.messages.process.RequestMoveHeroItemMessageImpl" scope="prototype">
		<property name="heroItemUtils" ref="heroItemUtils" />
		<property name="heroItemCalculations" ref="heroItemCalculations" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<!-- Singleton beans for server -->
	
	<bean id="userRegistry" class="com.ndg.multiplayer.server.users.MultiplayerSessionUserRegistryImpl" init-method="loadUserRegistry">
		<property name="xmlFilename" value="#{serverConfig.userRegistryFilename}" />
		<property name="schemaFactory" ref="schemaFactory" />
	</bean>

	<bean id="serverDatabaseConverters" class="momime.server.database.ServerDatabaseConvertersImpl" />
	
	<bean id="newGameDatabaseMessage" class="momime.common.messages.servertoclient.NewGameDatabaseMessage" factory-bean="serverDatabaseConverters" factory-method="buildNewGameDatabase">
		<constructor-arg value="#{serverConfig.pathToServerXmlDatabases}" />
		<constructor-arg ref="serverDatabaseUnmarshaller" />
	</bean>
	
	<bean id="momServer" class="momime.server.MomServer" init-method="start">
		<property name="clientToServerContext" ref="clientToServerJaxbContext" />
		<property name="serverToClientContext" ref="serverToClientJaxbContext" />
		<property name="savedGamesUnmarshaller" ref="savedGamesUnmarshaller" />
		<property name="savedGamesMarshaller" ref="savedGamesMarshaller" />
		<property name="savedGamesFolder" value="#{serverConfig.pathToSavedGames}" />
		<property name="zipSavedGames" value="true" />
		<property name="clientToServerContextFactoryArray">
			<array>
				<ref bean="multiplayerSessionServerClientToServerObjectFactory" />
				<ref bean="momServerClientToServerObjectFactory" />
				<ref bean="objectFactoryMap" />
			</array>
		</property>
		<property name="userRegistry" ref="userRegistry" />
		<property name="newGameDatabaseMessage" ref="newGameDatabaseMessage" />
		<property name="port" value="#{serverConfig.portNumber}" />
		<property name="conversationTag" value="#{'MoMIME-' + '${momime.server.version}'}" />
		<property name="sessionThreadFactory" ref="sessionThreadFactory" />
	</bean>
	
	<!-- Saved games support -->

	<bean id="serverKnowledgeObjectFactory" class="momime.server.knowledge.MomServerKnowledgeObjectFactory" />

	<bean id="savedGamesContext" class="javax.xml.bind.JAXBContext" factory-method="newInstance">
		<constructor-arg>
    		<list>
    			<value>com.ndg.multiplayer.persistence.SavedGame</value>
	   			<value>momime.common.messages.MomSessionDescription</value>
	   			<value>momime.common.messages.MomGeneralPublicKnowledge</value>
	   			<value>momime.server.messages.v0_9_7.MomGeneralServerKnowledge</value>
	   			<value>momime.server.messages.v0_9_7.ServerGridCell</value>
	   			<value>momime.common.messages.MomPersistentPlayerPublicKnowledge</value>
	   			<value>momime.common.messages.MomPersistentPlayerPrivateKnowledge</value>
    		</list>
   		</constructor-arg>
	</bean>

	<bean id="savedGamesUnmarshaller" class="javax.xml.bind.Unmarshaller" factory-bean="savedGamesContext" factory-method="createUnmarshaller" />
	
	<bean id="configureSavedGamesUnmarshaller" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
		<property name="targetObject" ref="savedGamesUnmarshaller" />
		<property name="targetMethod" value="setProperty" />
		<property name="arguments">
			<list>
				<value>com.sun.xml.bind.ObjectFactory</value>
				<array>
					<ref bean="serverKnowledgeObjectFactory" />
					<ref bean="objectFactoryMap" />
				</array>
			</list>
		</property>
	</bean>	
	
	<bean id="savedGamesMarshaller" class="javax.xml.bind.Marshaller" factory-bean="savedGamesContext" factory-method="createMarshaller" />

	<bean id="configureSavedGamesMarshaller" class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
		<property name="targetObject" ref="savedGamesMarshaller" />
		<property name="targetMethod" value="setProperty" />
		<property name="arguments">
			<list>
				<value>jaxb.formatted.output</value>
				<value type="java.lang.Boolean">true</value>
			</list>
		</property>
	</bean>

	<!-- Utils -->

	<bean id="playerPickServerUtils" class="momime.server.utils.PlayerPickServerUtilsImpl">
		<property name="playerPickUtils" ref="playerPickUtils" />
		<property name="spellUtils" ref="spellUtils" />
		<property name="spellAI" ref="spellAI" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="overlandMapServerUtils" class="momime.server.utils.OverlandMapServerUtilsImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
	</bean>

	<bean id="unitServerUtils" class="momime.server.utils.UnitServerUtilsImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="pendingMovementUtils" ref="pendingMovementUtils" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
	</bean>

	<bean id="cityServerUtils" class="momime.server.utils.CityServerUtilsImpl">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
	</bean>

	<bean id="spellServerUtils" class="momime.server.utils.SpellServerUtilsImpl">
		<property name="spellUtils" ref="spellUtils" />
	</bean>

	<bean id="playerServerUtils" class="momime.server.utils.PlayerServerUtilsImpl" />
	
	<bean id="heroItemServerUtils" class="momime.server.utils.HeroItemServerUtilsImpl">
		<property name="playerPickUtils" ref="playerPickUtils" />
		<property name="spellUtils" ref="spellUtils" />
	</bean>

	<bean id="treasureUtils" class="momime.server.utils.TreasureUtilsImpl">
		<property name="heroItemUtils" ref="heroItemUtils" />
		<property name="heroItemCalculations" ref="heroItemCalculations" />
		<property name="spellUtils" ref="spellUtils" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="playerPickUtils" ref="playerPickUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
		<property name="serverSpellCalculations" ref="serverSpellCalculations" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
	</bean>
	
	<!-- Calculations -->
	
	<bean id="serverSpellCalculations" class="momime.server.calculations.ServerSpellCalculationsImpl">
		<property name="spellUtils" ref="spellUtils" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="serverCityCalculations" class="momime.server.calculations.ServerCityCalculationsImpl">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
	</bean>

	<bean id="serverUnitCalculations" class="momime.server.calculations.ServerUnitCalculationsImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="serverResourceCalculations" class="momime.server.calculations.ServerResourceCalculationsImpl">
		<property name="spellQueueing" ref="spellQueueing" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="spellUtils" ref="spellUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="playerPickUtils" ref="playerPickUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="serverSpellCalculations" ref="serverSpellCalculations" />
		<property name="momResourceConsumerFactory" ref="momResourceConsumerFactory" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="damageTypeCalculations" class="momime.server.calculations.DamageTypeCalculationsImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
	</bean>

	<bean id="damageCalculator" class="momime.server.calculations.DamageCalculatorImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="spellUtils" ref="spellUtils" />
		<property name="damageTypeUtils" ref="damageTypeUtils" />
		<property name="damageTypeCalculations" ref="damageTypeCalculations" />
	</bean>
	
	<bean id="combatMapGenerator" class="momime.server.mapgenerator.CombatMapGeneratorImpl">
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="combatMapUtils" ref="combatMapUtils" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>
	
	<!-- Resource consumers -->

	<bean id="momResourceConsumerFactory" class="org.springframework.beans.factory.config.ServiceLocatorFactoryBean" >
		<property name="serviceLocatorInterface" value="momime.server.process.resourceconsumer.MomResourceConsumerFactory" />
	</bean>			

	<bean id="momResourceConsumerBuilding" class="momime.server.process.resourceconsumer.MomResourceConsumerBuilding" scope="prototype">
		<property name="cityProcessing" ref="cityProcessing" />
	</bean>

	<bean id="momResourceConsumerUnit" class="momime.server.process.resourceconsumer.MomResourceConsumerUnit" scope="prototype">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
	</bean>
	
	<bean id="momResourceConsumerSpell" class="momime.server.process.resourceconsumer.MomResourceConsumerSpell" scope="prototype">
		<property name="spellProcessing" ref="spellProcessing" />
	</bean>

	<!-- Processing -->

	<bean id="playerMessageProcessing" class="momime.server.process.PlayerMessageProcessingImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="skillCalculations" ref="skillCalculations" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarMidTurnMultiChanges" ref="fogOfWarMidTurnMultiChanges" />
		<property name="cityProcessing" ref="cityProcessing" />
		<property name="spellQueueing" ref="spellQueueing" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
		<property name="serverSpellCalculations" ref="serverSpellCalculations" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="momAI" ref="momAI" />
		<property name="cityAI" ref="cityAI" />
		<property name="playerServerUtils" ref="playerServerUtils" />
		<property name="simultaneousTurnsProcessing" ref="simultaneousTurnsProcessing" />
		<property name="combatStartAndEnd" ref="combatStartAndEnd" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
		<property name="savePointKeepCount" value="#{serverConfig.savePointKeepCount}" />
	</bean>

	<bean id="cityProcessing" class="momime.server.process.CityProcessingImpl">
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="playerPickServerUtils" ref="playerPickServerUtils" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="cityAI" ref="cityAI" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
	</bean>

	<bean id="spellProcessing" class="momime.server.process.SpellProcessingImpl">
		<property name="spellUtils" ref="spellUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarMidTurnMultiChanges" ref="fogOfWarMidTurnMultiChanges" />
		<property name="combatProcessing" ref="combatProcessing" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
		<property name="damageProcessor" ref="damageProcessor" />
		<property name="combatMapGenerator" ref="combatMapGenerator" />
		<property name="heroItemServerUtils" ref="heroItemServerUtils" />
		<property name="playerPickUtils" ref="playerPickUtils" />
		<property name="combatStartAndEnd" ref="combatStartAndEnd" />
	</bean>

	<bean id="spellQueueing" class="momime.server.process.SpellQueueingImpl">
		<property name="spellUtils" ref="spellUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="combatMapUtils" ref="combatMapUtils" />
		<property name="spellCalculations" ref="spellCalculations" />
		<property name="spellProcessing" ref="spellProcessing" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="heroItemServerUtils" ref="heroItemServerUtils" />
	</bean>

	<bean id="damageProcessor" class="momime.server.process.DamageProcessorImpl">
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarMidTurnMultiChanges" ref="fogOfWarMidTurnMultiChanges" />
		<property name="damageCalculator" ref="damageCalculator" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="combatStartAndEnd" ref="combatStartAndEnd" />
		<property name="attackResolutionProcessing" ref="attackResolutionProcessing" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
	</bean>
	
	<bean id="attackResolutionProcessing" class="momime.server.process.AttackResolutionProcessingImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
		<property name="damageCalculator" ref="damageCalculator" />
	</bean>

	<bean id="combatStartAndEnd" class="momime.server.process.CombatStartAndEndImpl">
		<property name="resourceValueUtils" ref="resourceValueUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarMidTurnMultiChanges" ref="fogOfWarMidTurnMultiChanges" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
		<property name="serverResourceCalculations" ref="serverResourceCalculations" />
		<property name="combatMapGenerator" ref="combatMapGenerator" />
		<property name="combatProcessing" ref="combatProcessing" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
	</bean>

	<bean id="combatProcessing" class="momime.server.process.CombatProcessingImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="fogOfWarDuplication" ref="fogOfWarDuplication" />
		<property name="combatMapUtils" ref="combatMapUtils" />
		<property name="combatAI" ref="combatAI" />
		<property name="damageProcessor" ref="damageProcessor" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
	</bean>
	
	<bean id="simultaneousTurnsProcessing" class="momime.server.process.SimultaneousTurnsProcessingImpl">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="cityProcessing" ref="cityProcessing" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="overlandMapServerUtils" ref="overlandMapServerUtils" />
		<property name="cityServerUtils" ref="cityServerUtils" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
	</bean>

	<!-- AI -->
	
	<bean id="spellAI" class="momime.server.ai.SpellAIImpl">
		<property name="spellUtils" ref="spellUtils" />
		<property name="randomUtils" ref="randomUtils" />
	</bean>

	<bean id="cityAI" class="momime.server.ai.CityAIImpl">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>

	<bean id="momAI" class="momime.server.ai.MomAIImpl">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="spellAI" ref="spellAI" />
		<property name="cityAI" ref="cityAI" />
	</bean>

	<bean id="combatAI" class="momime.server.ai.CombatAIImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitSkillUtils" ref="unitSkillUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="combatProcessing" ref="combatProcessing" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
	</bean>
	
	<!-- Fog of War -->

	<bean id="fogOfWarCalculations" class="momime.server.calculations.FogOfWarCalculationsImpl">
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
	</bean>

	<bean id="fogOfWarDuplication" class="momime.server.fogofwar.FogOfWarDuplicationImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
	</bean>

	<bean id="fogOfWarMidTurnVisibility" class="momime.server.fogofwar.FogOfWarMidTurnVisibilityImpl">
		<property name="unitUtils" ref="unitUtils" />
		<property name="fogOfWarCalculations" ref="fogOfWarCalculations" />
	</bean>

	<bean id="fogOfWarMidTurnChanges" class="momime.server.fogofwar.FogOfWarMidTurnChangesImpl">
		<property name="fogOfWarCalculations" ref="fogOfWarCalculations" />
		<property name="fogOfWarMidTurnVisibility" ref="fogOfWarMidTurnVisibility" />
		<property name="fogOfWarDuplication" ref="fogOfWarDuplication" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="pendingMovementUtils" ref="pendingMovementUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
	</bean>

	<bean id="fogOfWarMidTurnMultiChanges" class="momime.server.fogofwar.FogOfWarMidTurnMultiChangesImpl">
		<property name="fogOfWarCalculations" ref="fogOfWarCalculations" />
		<property name="fogOfWarProcessing" ref="fogOfWarProcessing" />
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="unitServerUtils" ref="unitServerUtils" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="unitCalculations" ref="unitCalculations" />
		<property name="cityCalculations" ref="cityCalculations" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
		<property name="combatStartAndEnd" ref="combatStartAndEnd" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
		<property name="treasureUtils" ref="treasureUtils" />
	</bean>

	<bean id="fogOfWarProcessing" class="momime.server.fogofwar.FogOfWarProcessingImpl">
		<property name="fogOfWarDuplication" ref="fogOfWarDuplication" />
		<property name="unitUtils" ref="unitUtils" />
		<property name="memoryBuildingUtils" ref="memoryBuildingUtils" />
		<property name="memoryCombatAreaEffectUtils" ref="memoryCombatAreaEffectUtils" />
		<property name="memoryMaintainedSpellUtils" ref="memoryMaintainedSpellUtils" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="serverCityCalculations" ref="serverCityCalculations" />
		<property name="serverUnitCalculations" ref="serverUnitCalculations" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
	</bean>
	
	<!-- Beans created each time a new session is started
	
			Note have to be careful here that each bean is only referenced once - if, for example, we declare
			"gsk" as a prototype bean and then try to set it against both the session thread + map generator, they
			will both get different copies of "gsk" injected
			
			So if there are places that something is genuinely required twice, we have to declare it only
			once here and then deal with copying the reference within the code -->
			
	<bean id="sessionThreadFactory" class="org.springframework.beans.factory.config.ServiceLocatorFactoryBean" >
		<property name="serviceLocatorInterface" value="momime.server.MomSessionThreadFactory" />
	</bean>			

	<bean id="trueMap" class="momime.common.messages.FogOfWarMemory" scope="prototype" />

	<bean id="gsk" class="momime.server.knowledge.MomGeneralServerKnowledgeEx" scope="prototype">
		<property name="trueMap" ref="trueMap" />
		<property name="nextFreeUnitURN" value="1" />
		<property name="nextFreeBuildingURN" value="1" />
		<property name="nextFreeSpellURN" value="1" />
		<property name="nextFreeCombatAreaEffectURN" value="1" />
		<property name="nextFreeHeroItemURN" value="1" />
	</bean>

	<bean id="gpk" class="momime.common.messages.MomGeneralPublicKnowledge" scope="prototype" />
	
	<bean id="overlandMapGenerator" class="momime.server.mapgenerator.OverlandMapGeneratorImpl" scope="prototype">
		<property name="fogOfWarMidTurnChanges" ref="fogOfWarMidTurnChanges" />
		<property name="memoryGridCellUtils" ref="memoryGridCellUtils" />
		<property name="randomUtils" ref="randomUtils" />
		<property name="coordinateSystemUtils" ref="coordinateSystemUtils" />
		<property name="booleanMapAreaOperations2D" ref="booleanMapAreaOperations2D" />
		<!-- <property name="gsk" ref="gsk" /> see comment above, this is done in the code instead -->
	</bean>

	<bean id="sessionThread" class="momime.server.MomSessionThread" scope="prototype">
		<property name="generalPublicKnowledge" ref="gpk" />
		<property name="generalServerKnowledge" ref="gsk" />
		<property name="overlandMapGenerator" ref="overlandMapGenerator" />
		<property name="multiplayerSessionServerUtils" ref="multiplayerSessionServerUtils" />
		<property name="serverDatabaseConverters" ref="serverDatabaseConverters" />
		<property name="serverDatabaseUnmarshaller" ref="serverDatabaseUnmarshaller" />
		<property name="pathToServerXmlDatabases" value="#{serverConfig.pathToServerXmlDatabases}" />
		<property name="playerMessageProcessing" ref="playerMessageProcessing" />
		<property name="heroItemServerUtils" ref="heroItemServerUtils" />
	</bean>
	
</beans>